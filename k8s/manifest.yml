#
# REG_USERNAME="admin"
# REG_PASWORD="snowdrop"
# REG_SERVER="registry.local:5000"
# kubectl create secret docker-registry local-registry -n fs --docker-server=$REG_SERVER --docker-username=$REG_USERNAME --docker-password=$REG_PASWORD
---
apiVersion: v1
kind: Namespace
metadata:
  name: buildpack
---
apiVersion: v1
kind: Secret
metadata:
  name: local-registry
  namespace: buildpack
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3RyeS5sb2NhbDo1MDAwIjp7InVzZXJuYW1lIjoiYWRtaW4iLCJwYXNzd29yZCI6InNub3dkcm9wIiwiYXV0aCI6IllXUnRhVzQ2YzI1dmQyUnliM0E9In19fQ==
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: buildpack
  namespace: buildpack
secrets:
  - name: local-registry
imagePullSecrets:
  - name: local-registry
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: buildah-poc-cache
  namespace: buildpack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500m
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: buildah-layers
  namespace: buildpack
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500m
---
apiVersion: v1
kind: Pod
metadata:
  name: buildah-poc
  namespace: buildpack
spec:
  volumes:
    - name: cache-dir
      persistentVolumeClaim:
        claimName: buildah-poc-cache
    - name: layers
      persistentVolumeClaim:
        claimName: buildah-layers
  initContainers:
    - name: check-before
      image: busybox:1.28
      command: [ "/bin/sh","-c" ]
      args:
        - |
          echo "## Check if Node exists within the /layers volume"
          echo "## /layers/usr/bin/node -v"
          /layers/usr/bin/node -v || true
      volumeMounts:
        - name: layers
          mountPath: /layers
    - name: buildah-bud
      image: registry.local:5000/snowdrop/buildah-poc
      env:
        - name: WORKSPACE_DIR
          value: "/workspace"
        - name: STORAGE_DRIVER
          value: "vfs"
      workingDir: /workspace
      command: [ "/bin/sh","-c" ]
      args:
        - |
          set -e

          echo "## Execute the go application able to "
          echo "## - Read a dockerfile"
          echo "## - Create locally an image"
          echo "## - Extract the layers created to the volume mounted /layers"
          echo "## Remark: Only one layer is extracted for the moment"
          echo buildah bud"
          cp /Dockerfile $WORKSPACE_DIR/
          cp /undocker.py $WORKSPACE_DIR/
          /bud

          echo -e "## Check if the image has been created locally"
          GRAPH_DRIVER="vfs"
          STORAGE_DIR=/var/lib/containers/storage
          buildah --storage-driver $GRAPH_DRIVER images

          EXTRACT_DIR="/layers"
          alias docker=podman
          REPO="localhost/buildpack-buildah"
          echo "## Extract the layer to $EXTRACT_DIR ####"

          TAG=$(buildah --storage-driver $GRAPH_DRIVER images | awk -v r="$REPO" '$0 ~ r {print $2;}')
          LAST_LAYER_ID=$(docker save $REPO:$TAG | ./undocker.py --layers | tail -n1)
          echo "Layer ID: $LAST_LAYER_ID"
          docker save $REPO:$TAG | ./undocker.py -iv -o $EXTRACT_DIR -l $LAST_LAYER_ID
      volumeMounts:
        - name: cache-dir
          mountPath: /workspace
        - name: layers
          mountPath: /layers
      imagePullPolicy: Always
      securityContext:
        privileged: true
    - name: check-after
      image: registry.access.redhat.com/ubi8:8.4-211 # busybox:1.28
      command: [ "/bin/sh","-c" ]
      args:
        - |
          echo "## Check if Node exists"
          echo "## Append /layers/usr/bin to the path"
          export PATH="/layers/usr/bin:$PATH"
          echo $PATH
          type -a node
          node -v
      volumeMounts:
        - name: layers
          mountPath: /layers
      securityContext:
        privileged: true
  containers:
    - name: completion
      image: busybox:1.28
      command: [ "/bin/sh","-c","--" ]
      args: [ "while true; do sleep 30; done;" ]
      volumeMounts:
      - name: layers
        mountPath: /layers
  serviceAccountName: buildpack

